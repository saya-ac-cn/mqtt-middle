<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ac.cn.saya.mqtt.middle.repository.IotProductRulesDAO">

    <resultMap type="iotProductRules" id="iotProductRulesMap">
        <result property="id" column="id"/>
        <result property="productId" column="productId"/>
        <result property="ruleId" column="ruleId"/>
        <association property="rule" javaType="iotWarningRules">
            <result property="id" column="ruleId"/>
            <result property="name" column="name"/>
            <result property="abilityId" column="abilityId"/>
            <result property="symbol" column="symbol"/>
            <result property="value1" column="value1"/>
            <result property="value2" column="value2"/>
            <result property="enable" column="enable"/>
            <result property="createTime" column="create_time"/>
            <result property="updateTime" column="update_time"/>
            <association property="abilityEntity" javaType="iotAbility">
                <result property="id" column="abilityId"/>
                <result property="productId" column="productId"/>
                <result property="property" column="property"/>
                <result property="standardId" column="standardId"/>
                <result property="type" column="type"/>
                <result property="scope" column="scope"/>
                <result property="rwFlag" column="rwFlag"/>
            </association>
        </association>
    </resultMap>

    <resultMap type="iotWarningRules" id="iotWarningRulesMap">
        <result property="id" column="id"/>
        <result property="name" column="name"/>
        <result property="abilityId" column="abilityId"/>
        <result property="symbol" column="symbol"/>
        <result property="value1" column="value1"/>
        <result property="value2" column="value2"/>
        <result property="enable" column="enable"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
        <association property="abilityEntity" javaType="iotAbility">
            <result property="id" column="ability_id"/>
            <result property="productId" column="productId"/>
            <result property="property" column="property"/>
            <result property="standardId" column="standardId"/>
            <result property="type" column="type"/>
            <result property="scope" column="scope"/>
            <result property="rwFlag" column="rwFlag"/>
        </association>
    </resultMap>

    <!-- 查询指定设备关联的规则列表 -->
    <select id="queryByProductId" resultMap="iotWarningRulesMap">
        select
            a.`id`,b.`name`, b.`ability_id`,b.`symbol`, b.`value1`,b.`value2`, b.`enable`, b.`create_time`, b.`update_time`,
            c.`product_id` as productId, c.`property`,c.`standard_id` as standardId,c.`type`,c.`scope`,c.`rw_flag` as rwFlag
        from
            iot_product_rules a
            left join iot_warning_rules b on a.rule_id= b.id
            left join iot_ability c on b.`ability_id` = c.`id`
        <where>
            <if test="productId != null and productId != 0">
                a.product_id = ${productId}
            </if>
            <if test="enable != null and enable != 0">
                and b.`enable` = #{enable}
            </if>
        </where>
    </select>

    <!-- 查询指定规则关联的设备列表 -->
    <select id="queryByRule" resultType="java.lang.Integer">
        select  z.product_id
        from iot_product_rules z
        where z.rule_id = ${ruleId}
    </select>

    <!--查询设备绑定的告警规则-->
    <select id="query" parameterType="iotProductRules" resultMap="iotProductRulesMap">
    select
        a.`id`,a.`product_id` as productId,a.`rule_id` as ruleId,
        b.`name`, b.`ability_id`,b.`symbol`, b.`value1`,b.`value2`, b.`enable`, b.`create_time`, b.`update_time`,
        c.`product_id` as productId, c.`property`,c.`standard_id` as standardId,c.`type`,c.`scope`,c.`rw_flag` as rwFlag
    from
        iot_product_rules a
        left join iot_warning_rules b on a.rule_id= b.id
        left join iot_ability c on b.`ability_id` = c.`id`
        <where>
            <if test="id != null and id != 0">
                a.`id` = #{id}
            </if>
            <if test="productId != null and productId != 0">
                and a.`product_id` = #{productId}
            </if>
            <if test="ruleId != null and ruleId != 0">
                and a.`rule_id` = #{ruleId}
            </if>
            <if test="enable != null and enable != 0">
                and b.`enable` = #{enable}
            </if>
        </where>
        limit 1
    </select>

    <!--分页查询设备绑定的告警规则-->
    <select id="queryPage" parameterType="iotProductRules" resultMap="iotProductRulesMap">
        select
            a.`id`,a.`product_id` as productId,a.`rule_id` as ruleId,
            b.`name`, b.`ability_id` as abilityId,b.`symbol`, b.`value1`,b.`value2`, b.`enable`, b.`create_time`, b.`update_time`,
            c.`product_id` as productId, c.`property`,c.`standard_id` as standardId,c.`type`,c.`scope`,c.`rw_flag` as rwFlag
        from
            iot_product_rules a
            left join iot_warning_rules b on a.rule_id= b.id
            left join iot_ability c on b.`ability_id` = c.`id`
            <where>
                <if test="id != null and id != 0">
                    a.`id` = #{id}
                </if>
                <if test="productId != null and productId != 0">
                    and a.`product_id` = #{productId}
                </if>
                <if test="ruleId != null and ruleId != 0">
                    and a.`rule_id` = #{ruleId}
                </if>
                <if test="enable != null and enable != 0">
                    and b.`enable` = #{enable}
                </if>
            </where>
        order by a.`id` desc
        limit #{startLine},#{endLine}
    </select>

    <!--查询设备绑定的告警规则数量-->
    <select id="queryCount" parameterType="iotProductRules" resultType="java.lang.Long">
        select
            count(*)
        from iot_product_rules a
        <if test="enable != null and enable != 0">
            left join iot_warning_rules b on a.rule_id= b.id
        </if>
        <where>
            <if test="id != null and id != 0">
                a.`id` = #{id}
            </if>
            <if test="productId != null and productId != 0">
                and a.`product_id` = #{productId}
            </if>
            <if test="ruleId != null and ruleId != 0">
                and a.`rule_id` = #{ruleId}
            </if>
            <if test="enable != null and enable != 0">
                and b.`enable` = #{enable}
            </if>
        </where>
    </select>

    <!--绑定设备告警规则-->
    <insert id="insert" parameterType="java.util.List">
        insert into iot_product_rules(`product_id`, `rule_id`)
        values
        <foreach collection="list" item="id" index="index" separator=",">
            (#{productId}, #{id})
        </foreach>
    </insert>

    <!--修改设备绑定的告警规则-->
    <update id="update" parameterType="java.util.List">
        update iot_product_rules
        <set>
            <if test="productId != null and productId != 0">
                `product_id` = #{productId},
            </if>
            <if test="ruleId != null and ruleId != 0">
                `rule_id` = #{ruleId}
            </if>
        </set>
        where `id` = #{id}
    </update>

    <!--解绑设备告警规则-->
    <delete id="deleteById" parameterType = "java.util.List">
        delete from iot_product_rules where `id` in
        <foreach collection="list"  item="item" open="(" separator="," close=")">
            #{item}
        </foreach>
    </delete>


    <!--解绑设备告警规则-->
    <delete id="deleteByRule" parameterType = "java.lang.Integer">
        delete from iot_product_rules where `rule_id`  = #{ruleId}
    </delete>

</mapper>